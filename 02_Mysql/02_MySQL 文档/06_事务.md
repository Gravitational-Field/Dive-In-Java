# 事务

## 目标

- 事务介绍
- 事务的四大特性

**准备数据**

## 1. 事务介绍

事务广泛的运用于订单系统、银行系统等多种场景

例如：

> A用户和B用户是银行的储户，现在A要给B转账500元，那么需要做以下几件事：
>
> 1. 检查A的账户余额>500元；
> 2. A 账户中扣除500元;
> 3. B 账户中增加500元;

正常的流程走下来，A账户扣了500，B账户加了500，皆大欢喜。

那如果A账户扣了钱之后，系统出故障了呢？A白白损失了500，而B也没有收到本该属于他的500。

以上的案例中，隐藏着一个前提条件：A扣钱和B加钱，要么**同时成功**，要么**同时失败**。事务的需求就在于此

所谓**事务**,它**是一个操作序列，这些操作要么都执行，要么都不执行，它是一个不可分割的工作单位**。

例如，银行转帐工作：从一个帐号扣款并使另一个帐号增款，这两个操作要么都执行，要么都不执行。所以，应该把他们看成一个事务。事务是数据库维护数据一致性的单位，在每个事务结束时，都能保持数据一致性

## 2. 事务四大特性

- 原子性(Atomicity)
- 一致性(Consistency)
- 隔离性(Isolation)
- 持久性(Durability)

**案例**

A用户和B用户是银行的储户，现在A要给B转账500元：

```sql
CREATE TABLE t_account (
  account_name varchar(50) NOT NULL,
  money double NOT NULL
);
INSERT INTO t_account VALUES ('A', '1000');
INSERT INTO t_account VALUES ('B', '1000');

1. 检查A的账户余额>500元；
2. A 账户中扣除500元;
3. B 账户中增加500元;
```

上述三个步骤的操作必须打包在一个事务中，任何一个步骤失败，则必须回滚所有的步骤。

可以用START TRANSACTION语句开始一个事务，然后要么使用COMMIT提交将修改的数据持久保存，要么使用ROLLBACK撤销所有的修改。事务SQL的样本如下：

```sql
START TRANSACTION;
SELECT * FROM t_account WHERE account_name='A';
UPDATE t_account SET money = money - 500 WHERE account_name='A';
UPDATE t_account SET money = money + 500 WHERE account_name='B';
SELECT * FROM t_account;
-- COMMIT;
ROLLBACK;
```

一个很好的事务处理系统，必须具备这些标准特性：

- **原子性**（atomicity）

> 一个事务必须被视为一个不可分割的最小工作单元，整个事务中的所有操作要么全部提交成功，要么全部失败回滚，对于一个事务来说，不可能只执行其中的一部分操作，这就是事务的原子性

- **一致性**（consistency）

> 数据库总是从一个一致性的状态转换到另一个一致性的状态。（在前面的例子中，一致性确保了，即使在执行第三、四条语句之间时系统崩溃，支票账户中也不会损失200美元，因为事务最终没有提交，所以事务中所做的修改也不会保存到数据库中。）

- **隔离性**（isolation）

> 通常来说，一个事务所做的修改在最终提交以前，对其他事务是不可见的。（在前面的例子中，当执行完第三条语句、第四条语句还未开始时，此时有另外的一个账户汇总程序开始运行，则其看到支票帐户的余额并没有被减去200美元。）

- **持久性**（durability）

> 一旦**事务提交**，则其所做的修改会永久保存到数据库。（此时即使系统崩溃，修改的数据也不会丢失。）



## 3. 事务命令

**表的引擎类型必须是innodb类型才可以使用事务，这是mysql表的默认引擎**

查看表的创建语句，可以看到engine=innodb

```sql
-- 查看t_student表
show create table t_student;
```

### 开启事务

- 开启事务后执行修改命令，变更会维护到本地缓存中，而不维护到物理表中

```sql
begin;
或者
start transaction;
```

### 提交事务

- 将缓存中的数据变更维护到物理表中

```sql
commit;
```

### 回滚事务

- 放弃缓存中变更的数据

```sql
rollback;
```

### 注意事项

- 修改数据的命令会自动的触发事务，包括`insert`、`update`、`delete`
- 而在SQL语句中有**手动开启事务**的原因是：可以进行多次数据的修改，如果成功一起成功，否则一起会滚到之前的数据